## Step 5 实验报告

2018011359 	计84 乐阳

### 实验过程

Step 5要求实现局部变量。一个函数的局部变量保存在其栈帧中，通过距离栈帧指针`fp`的偏移量来访问。因此局部变量有三个特征：符号名称、类型和偏移量。程序中，`Symbol`类用来表示局部变量：

```python
class Symbol:
    def __init__(self, name, offset, ty):
        self.name = name		# 符号名称
        self.offset = offset	# 偏移量
        self.ty = ty			# 变量类型
```

`symbolTable`用来存储所有的局部变量方便查找。

在进入一个函数时，维护一个计数器`localCnt`表示当前函数中局部变量的个数。发现一个新的局部变量声明时，根据当前局部变量的个数可以换算出该局部变量的偏移量。

```python 
# visitLocalDecl
self.symbolTable[name] = Symbol(name, -4 * self.localCnt, IntType())
```

 加载局部变量的值时查询`symbolTable`得到`symbol`的偏移量，然后使用的汇编语句为`lw t0, symbol.offset, (fp)`。如果没找到则说明使用了未声明的变量，报错。

对于一条新的局部变量声明，需要检查该局部变量是否被重复声明，通过查询`symbolTable`来实现。

在函数执行前需要为局部变量开辟栈存储空间，不过这在扫描函数体之前空间的大小未知。需要在遍历完该函数的每条语句后再回填上开辟空间的大小。

### 思考题

1. 描述程序运行过程中函数栈帧的构成，分成哪几个部分？每个部分所用空间最少是多少？

   答：分为如下几个部分：

   - 被调用者保存的寄存器（至少有`fp`和`ra`，最少空间为8 bytes）
   - 局部变量（可以没有，最少空间为0）
   - 返回值，运算中的临时变量（可以没有，最少空间为0）
   - 子函数的参数（当子函数参数超过传参寄存器个数时，可以没有，最少空间为0）

   

2. 如果 MiniDecaf 也允许多次定义同名变量，并规定新的定义会覆盖之前的同名定义，请问在你的实现中，需要对定义变量和查找变量的逻辑做怎样的修改？

   答：定义变量时新的定义直接覆盖原有定义（操作`symbolTable`），不检查该符号名是否已存在。查找变量的逻辑不需要修改。

